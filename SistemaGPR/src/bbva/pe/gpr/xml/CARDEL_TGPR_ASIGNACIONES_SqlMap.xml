<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CARDEL_TGPR_ASIGNACIONES" >
  <resultMap id="ibatorgenerated_BaseResultMap" class="bbva.pe.gpr.bean.Asignacion" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Tue Sep 25 16:43:19 COT 2012.
    -->
    <result column="COD_ASIGNACION" property="codAsignacion" jdbcType="DECIMAL" />
    <result column="COD_USUARIO" property="codUsuario" jdbcType="VARCHAR" />
    <result column="NRO_SOLICITUD" property="nroSolicitud" jdbcType="DECIMAL" />
    <result column="NOMBRE" property="nombre" jdbcType="VARCHAR" />
    <result column="COD_ROL" property="codRol" jdbcType="DECIMAL" />
    <result column="DEPENDIENTE" property="dependiente" jdbcType="VARCHAR" />
    <result column="COD_USUARIO_ASIGNO" property="codUsuarioAsigno" jdbcType="VARCHAR" />
    <result column="FECHA_ASIGNACION" property="fechaAsignacion" jdbcType="DATE" />
    <result column="ESTADO" property="estado" jdbcType="DECIMAL" />
    <result column="COD_CENTRAL" property="codCentral" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap id="mapAsignacion" class="bbva.pe.gpr.bean.Asignacion" >
	<result column="COD_ASIGNACION" property="codAsignacion" jdbcType="DECIMAL" />
	<result column="NRO_SOLICITUD" property="nroSolicitud" jdbcType="DECIMAL" />
	<result column="DES_SOLICITANTE" property="nombre" jdbcType="VARCHAR" />
	<result column="COD_CENTRAL" property="codCentral" jdbcType="VARCHAR" />
	<result column="FECHA_INGRESO" property="fechaIngreso" jdbcType="DATE" />
	<result column="FUERA_RANGO" property="flagFueraRangoSi" jdbcType="VARCHAR" />
	<result column="MONTO" property="mtoDelegacionMax" jdbcType="DECIMAL" />
	<result column="RIESGO_ACTUAL" property="riesgoActual" jdbcType="DECIMAL" />
	<result column="RIESGO_TOTAL" property="riesgoTotal" jdbcType="DECIMAL" />
	<result column="PRIORIDAD" property="prioridad" jdbcType="VARCHAR" />
	<result column="COD_MULT_MONEDA" property="codMoneda" jdbcType="VARCHAR" />
	<result column="SRT_FECHA_ASIGNACION" property="strFechaAsignacion" jdbcType="VARCHAR" />
  </resultMap>
  
  <select id="ibatorgenerated_selectByPrimaryKey" resultMap="ibatorgenerated_BaseResultMap" parameterClass="bbva.pe.gpr.bean.AsignacionKey" >
    select COD_ASIGNACION, COD_USUARIO, NRO_SOLICITUD, NOMBRE, COD_ROL, DEPENDIENTE,
      COD_USUARIO_ASIGNO, FECHA_ASIGNACION, ESTADO, COD_CENTRAL
    from CARDEL.TGPR_ASIGNACIONES
    where COD_ASIGNACION = #codAsignacion:DECIMAL#
      and COD_USUARIO = #codUsuario:VARCHAR#
      and NRO_SOLICITUD = #nroSolicitud:DECIMAL#
  </select>
  <delete id="ibatorgenerated_deleteByPrimaryKey" parameterClass="bbva.pe.gpr.bean.AsignacionKey" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Tue Sep 25 16:43:19 COT 2012.
    -->
    delete from CARDEL.TGPR_ASIGNACIONES
    where COD_ASIGNACION = #codAsignacion:DECIMAL#
      and COD_USUARIO = #codUsuario:VARCHAR#
      and NRO_SOLICITUD = #nroSolicitud:DECIMAL#
  </delete>
  <insert id="ibatorgenerated_insert" parameterClass="bbva.pe.gpr.bean.Asignacion" >
     <selectKey keyProperty="codAsignacion" resultClass="Long">
    	  SELECT CARDEL.SQ_TCARDEL_ASIGNACION_COD.NEXTVAL FROM DUAL
  	</selectKey>
  	insert into CARDEL.TGPR_ASIGNACIONES (COD_ASIGNACION, COD_USUARIO, NRO_SOLICITUD, NOMBRE,
      COD_ROL, DEPENDIENTE, COD_USUARIO_ASIGNO, FECHA_ASIGNACION, ESTADO, COD_CENTRAL)
    values (#codAsignacion:DECIMAL#, #codUsuario:VARCHAR#, #nroSolicitud:DECIMAL#, #nombre:VARCHAR#,
      #codRol:DECIMAL#, #dependiente:VARCHAR#, #codUsuarioAsigno:VARCHAR#,
      SYSDATE, #estado:DECIMAL#, #codCentral:VARCHAR#)
  </insert>
  <insert id="ibatorgenerated_insertSelective" parameterClass="bbva.pe.gpr.bean.Asignacion" >
    insert into CARDEL.TGPR_ASIGNACIONES
    <dynamic prepend="(" >
      <isNotNull prepend="," property="codAsignacion" >
        COD_ASIGNACION
      </isNotNull>
      <isNotNull prepend="," property="codUsuario" >
        COD_USUARIO
      </isNotNull>
      <isNotNull prepend="," property="nroSolicitud" >
        NRO_SOLICITUD
      </isNotNull>
      <isNotNull prepend="," property="nombre" >
        NOMBRE
      </isNotNull>
      <isNotNull prepend="," property="codRol" >
        COD_ROL
      </isNotNull>
      <isNotNull prepend="," property="dependiente" >
        DEPENDIENTE
      </isNotNull>
      <isNotNull prepend="," property="codUsuarioAsigno" >
        COD_USUARIO_ASIGNO
      </isNotNull>
      <isNotNull prepend="," property="fechaAsignacion" >
        FECHA_ASIGNACION
      </isNotNull>
      <isNotNull prepend="," property="estado" >
        ESTADO
      </isNotNull>
      <isNotNull prepend="," property="codCentral" >
        COD_CENTRAL
      </isNotNull>
      )
    </dynamic>
    values
    <dynamic prepend="(" >
      <isNotNull prepend="," property="codAsignacion" >
        #codAsignacion:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="codUsuario" >
        #codUsuario:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="nroSolicitud" >
        #nroSolicitud:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="nombre" >
        #nombre:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="codRol" >
        #codRol:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="dependiente" >
        #dependiente:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="codUsuarioAsigno" >
        #codUsuarioAsigno:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="fechaAsignacion" >
        #fechaAsignacion:DATE#
      </isNotNull>
      <isNotNull prepend="," property="estado" >
        #estado:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="codCentral" >
        #codCentral:VARCHAR#
      </isNotNull>
      )
    </dynamic>
  </insert>
  <update id="ibatorgenerated_updateByPrimaryKeySelective" parameterClass="bbva.pe.gpr.bean.Asignacion" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Tue Sep 25 16:43:19 COT 2012.
    -->
    update CARDEL.TGPR_ASIGNACIONES
    <dynamic prepend="set" >
      <isNotNull prepend="," property="nombre" >
        NOMBRE = #nombre:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="codRol" >
        COD_ROL = #codRol:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="dependiente" >
        DEPENDIENTE = #dependiente:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="codUsuarioAsigno" >
        COD_USUARIO_ASIGNO = #codUsuarioAsigno:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="fechaAsignacion" >
        FECHA_ASIGNACION = #fechaAsignacion:DATE#
      </isNotNull>
      <isNotNull prepend="," property="estado" >
        ESTADO = #estado:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="codCentral" >
        COD_CENTRAL = #codCentral:VARCHAR#
      </isNotNull>
    </dynamic>
    where COD_ASIGNACION = #codAsignacion:DECIMAL#
      and COD_USUARIO = #codUsuario:VARCHAR#
      and NRO_SOLICITUD = #nroSolicitud:DECIMAL#
  </update>
  <update id="ibatorgenerated_updateByPrimaryKey" parameterClass="bbva.pe.gpr.bean.Asignacion" >
    <!--
      WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify.
      This element was generated on Tue Sep 25 16:43:19 COT 2012.
    -->
    update CARDEL.TGPR_ASIGNACIONES
    set NOMBRE = #nombre:VARCHAR#,
      COD_ROL = #codRol:DECIMAL#,
      DEPENDIENTE = #dependiente:VARCHAR#,
      COD_USUARIO_ASIGNO = #codUsuarioAsigno:VARCHAR#,
      FECHA_ASIGNACION = #fechaAsignacion:DATE#,
      ESTADO = #estado:DECIMAL#,
      COD_CENTRAL = #codCentral:VARCHAR#
    where COD_ASIGNACION = #codAsignacion:DECIMAL#
      and COD_USUARIO = #codUsuario:VARCHAR#
      and NRO_SOLICITUD = #nroSolicitud:DECIMAL#
  </update>
   <parameterMap id="pBanlance" class="Map">
	  <parameter property="result" javaType="java.lang.String"
	             jdbcType="VARCHAR" mode="OUT"/> 
	  <parameter property="pCOD_BANCA" javaType="java.math.BigDecimal"
	             jdbcType="NUMBER" mode="IN" />
	  <parameter property="pCOD_ROL" javaType="java.math.BigDecimal"
	             jdbcType="NUMBER" mode="IN" />           
  </parameterMap>
  <procedure id="getUsuarioPorBalance" parameterMap="pBanlance">
     <![CDATA[
      { ? = call  CARDEL.PCARDEL_COMMON.BALANCEO_CARGA(?,?) }
     ]]>
  </procedure>
  <select id="getLstAsignaciones" resultMap="mapAsignacion" parameterClass="bbva.pe.gpr.bean.Asignacion" >
		 SELECT A.COD_ASIGNACION,
         TO_CHAR(A.FECHA_ASIGNACION,'DD/MM/YYYY')  SRT_FECHA_ASIGNACION,
         A.NRO_SOLICITUD, 
         A.COD_CENTRAL, 
         S.DES_SOLICITANTE, 
         S.COD_MULT_MONEDA,
         SUM(SD.MTO_PRODUCTO) AS MONTO, 
         S.RIESGO_ACTUAL, 
         CARDEL.PCARDEL_COMMON.SUMAR(SUM(SD.MTO_PRODUCTO), S.RIESGO_ACTUAL) RIESGO_TOTAL, 
         S.PRIORIDAD, 
         (CARDEL.PCARDEL_COMMON.FN_VALIDA_RANGO(CARDEL.PCARDEL_COMMON.SUMAR(SUM(SD.MTO_PRODUCTO), S.RIESGO_ACTUAL), 100000000)) AS FUERA_RANGO , 
         (S.FECHA_INGRESO + 60)  FECHA_INGRESO  
    FROM CARDEL.TGPR_ASIGNACIONES A, CARDEL.TGPR_SOLICITUDES S, CARDEL.TGPR_SOLICITUD_DETALLES SD
    WHERE A.NRO_SOLICITUD = S.NRO_SOLICITUD  
        AND  A.NRO_SOLICITUD = SD.NRO_SOLICITUD 
        AND  S.NRO_SOLICITUD = SD.NRO_SOLICITUD
        AND  ( #estadoAsignacion:VARCHAR# IS NULL OR #estadoAsignacion:VARCHAR# = '' OR A.ESTADO_ASIGNACION = UPPER(#estadoAsignacion:VARCHAR#))
        AND  ( (#fechaIngresoIni:DATE# IS NULL AND #FechaIngresoFin:DATE# IS NULL) OR (TO_DATE(TO_CHAR(S.FECHA_INGRESO,'DD/MM/YYYY'),'DD/MM/YYYY') BETWEEN #fechaIngresoIni:DATE# AND #FechaIngresoFin:DATE# )) 
	    AND  ( #codCentral:VARCHAR# IS NULL OR #codCentral:VARCHAR# = '' OR S.COD_CENTRAL = UPPER(#codCentral:VARCHAR#)) 
	    AND  ( #nroSolicitud:DECIMAL# IS NULL OR #nroSolicitud:DECIMAL# = -1 OR S.NRO_SOLICITUD = #nroSolicitud:DECIMAL#)
	    AND  ( #codUsuario:VARCHAR# IS NULL OR #codUsuario:VARCHAR# = '' OR A.COD_USUARIO=#codUsuario:VARCHAR#)
    GROUP BY (A.FECHA_ASIGNACION, A.NRO_SOLICITUD, A.COD_CENTRAL, S.DES_SOLICITANTE, S.COD_MULT_MONEDA, 
    S.RIESGO_ACTUAL, S.RIESGO_TOTAL, S.PRIORIDAD, S.FECHA_INGRESO, A.COD_ASIGNACION)   
	</select>	
</sqlMap>